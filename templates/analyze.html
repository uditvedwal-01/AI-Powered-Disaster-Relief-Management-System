<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Real-Time Analysis - {{ disaster.Name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand text-white" href="/">Relief Matrix : A Disaster Relief Management System</a>
        <div class="navbar-nav">
          <a class="nav-link" href="{{ url_for('index') }}">Home</a>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2>Real-Time Analysis Dashboard</h2>
          <p class="text-muted mb-0">{{ disaster.Name }} • {{ disaster.Type or 'Unknown Type' }} • {{ disaster.Location or 'Unknown Location' }}</p>
          <small class="text-success">Live Data • Last Updated: <span id="lastUpdate">Loading...</span></small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">Refresh</button>
          <button class="btn btn-outline-success btn-sm" onclick="exportReport()">Export</button>
          <a href="{{ url_for('disaster_detail', disaster_id=disaster.DisasterID) }}" class="btn btn-primary">← Back to Disaster</a>
        </div>
      </div>

      <!-- Key Performance Indicators -->
      <div class="row g-4 mb-4">
        <div class="col-md-3">
          <div class="card text-center border-primary">
            <div class="card-body">
              <h3 class="card-title text-primary">{{ warehouses|length }}</h3>
              <p class="card-text">Active Warehouses</p>
              <small class="text-muted">Total Capacity: {{ warehouses|sum(attribute='Capacity') if warehouses else 0 }}</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-success">
            <div class="card-body">
              <h3 class="card-title text-success">{{ items|sum(attribute='Quantity') if items else 0 }}</h3>
              <p class="card-text">Total Items in Stock</p>
              <small class="text-muted">{{ items|length }} Different Items</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-warning">
            <div class="card-body">
              <h3 class="card-title text-warning">{{ beneficiaries|length }}</h3>
              <p class="card-text">Beneficiaries Served</p>
              <small class="text-muted">Affected Population</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center border-info">
            <div class="card-body">
              <h3 class="card-title text-info">{{ distributions|sum(attribute='Quantity') if distributions else 0 }}</h3>
              <p class="card-text">Items Distributed</p>
              <small class="text-muted">{{ distributions|length }} Distribution Events</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis Insights -->
      <div class="row g-4 mb-4">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Key Insights & Analysis</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 class="text-primary">Resource Utilization</h6>
                  <ul class="list-unstyled">
                    <li><strong>Utilization Rate:</strong> {{ ((distributions|sum(attribute='Quantity') / items|sum(attribute='Quantity') * 100) if items and items|sum(attribute='Quantity') > 0 else 0)|round(1) }}%</li>
                    <li><strong>Avg Distribution Size:</strong> {{ (distributions|sum(attribute='Quantity') / distributions|length)|round(1) if distributions else 0 }} items</li>
                    <li><strong>Most Distributed Item:</strong> 
                      {% if distributions %}
                        {% set most_distributed = distributions|max(attribute='Quantity') %}
                        {{ most_distributed.item.Name if most_distributed and most_distributed.item else 'N/A' }}
                      {% else %}
                        N/A
                      {% endif %}
                    </li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <h6 class="text-success">Performance Metrics</h6>
                  <ul class="list-unstyled">
                    <li><strong>Response Efficiency:</strong> 
                      {% if disaster.StartDate and distributions %}
                        {% set first_distribution = distributions|min(attribute='Date') %}
                        {% if first_distribution and first_distribution.Date > disaster.StartDate %}
                          {{ (first_distribution.Date - disaster.StartDate).days }} days
                        {% else %}
                          0 days
                        {% endif %}
                      {% else %}
                        N/A
                      {% endif %}
                    </li>
                    <li><strong>Coverage Rate:</strong> {{ ((beneficiaries|length / (beneficiaries|length + 1)) * 100)|round(1) }}%</li>
                    <li><strong>Resource per Person:</strong> {{ ((items|sum(attribute='Quantity') / beneficiaries|length) if beneficiaries else 0)|round(1) }} items</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Alerts & Status</h5>
            </div>
            <div class="card-body">
              {% set low_stock_items = items|selectattr('Quantity', 'lt', 10)|list %}
              {% if low_stock_items %}
                <div class="alert alert-warning">
                  <h6>Low Stock Alert</h6>
                  <p class="mb-0">{{ low_stock_items|length }} items below 10 units</p>
                </div>
              {% endif %}
              
              {% if not distributions %}
                <div class="alert alert-info">
                  <h6>No Distributions</h6>
                  <p class="mb-0">No distributions recorded yet</p>
                </div>
              {% endif %}
              
              {% if items|sum(attribute='Quantity') > 0 %}
                <div class="alert alert-success">
                  <h6>System Active</h6>
                  <p class="mb-0">Resources available for distribution</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Tables -->
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Inventory Status</h5>
              <span class="badge bg-info">Real-time</span>
            </div>
            <div class="card-body">
              {% if items %}
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Stock</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in items %}
                      <tr>
                        <td>{{ item.Name }}</td>
                        <td><span class="badge bg-secondary">{{ item.Category or 'Uncategorized' }}</span></td>
                        <td><span class="badge bg-primary">{{ item.Quantity }}</span></td>
                        <td>
                          {% if item.Quantity < 10 %}
                            <span class="badge bg-danger">Low Stock</span>
                          {% elif item.Quantity < 50 %}
                            <span class="badge bg-warning">Medium</span>
                          {% else %}
                            <span class="badge bg-success">Good</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted text-center">No items in inventory yet.</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Recent Activity</h5>
              <span class="badge bg-success">Live</span>
            </div>
            <div class="card-body">
              {% if distributions %}
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Item</th>
                        <th>Qty</th>
                        <th>Beneficiary</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for dist in distributions[-5:] if distributions %}
                      <tr>
                        <td><small>{{ dist.Date }}</small></td>
                        <td>{{ dist.item.Name if dist.item else 'Unknown' }}</td>
                        <td><span class="badge bg-success">{{ dist.Quantity }}</span></td>
                        <td><small>{{ dist.beneficiary.Name if dist.beneficiary else 'Unknown' }}</small></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted text-center">No distributions recorded yet.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Auto-refresh functionality  
      function refreshData() {
        location.reload();
      }

      function exportReport() {
        // Simple export functionality
        const data = {
          disaster: '{{ disaster.Name }}',
          timestamp: new Date().toISOString(),
          warehouses: {{ warehouses|length if warehouses else 0 }},
          totalItems: {{ items|sum(attribute='Quantity') if items else 0 }},
          beneficiaries: {{ beneficiaries|length if beneficiaries else 0 }},
          distributions: {{ distributions|length if distributions else 0 }}
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'disaster_analysis_{{ disaster.Name }}.json';
        a.click();
      }

      // Initialize and update timestamp
      function updateTimestamp() {
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      }
      
      // Set initial timestamp
      updateTimestamp();
      
      // Update timestamp every minute
      setInterval(updateTimestamp, 60000);
    </script>
  </body>
  </html>


